(() => {
  if (window.ChartDataLabels && window.Chart) {
    Chart.register(window.ChartDataLabels);
  }

  const form = document.getElementById('form-filtros');
  const selCliente = document.getElementById('cliente_id');
  const desde = document.getElementById('fecha_desde');
  const hasta = document.getElementById('fecha_hasta');
  const btnLimpiar = document.getElementById('btn-limpiar');

  const msg = document.getElementById('msg-seleccione');
  const chartsWrap = document.getElementById('charts');
  const tbody = document.getElementById('tbody-eventos');
  const eventosWrap = document.getElementById('eventos_qas');

  const kpiWrap = document.getElementById('kpi');
  const kpiAvg = document.getElementById('kpi_avg_ticket');
  const kpiNum = document.getElementById('kpi_num');
  const kpiTotal = document.getElementById('kpi_total');

  let chartEventos = null;
  let chartEncuestas = null;
  let lastEventos = [];
  let selectedDay = null;      // barra seleccionada (YYYY-MM-DD)
  let selectedStatus = null;   // 'Completadas' | 'Pendientes'

  function resetUI() {
    if (chartEventos) { chartEventos.destroy(); chartEventos = null; }
    if (chartEncuestas) { chartEncuestas.destroy(); chartEncuestas = null; }
    tbody.innerHTML = '';
    chartsWrap.style.display = 'none';
    eventosWrap.style.display = 'none';
    if (kpiWrap) kpiWrap.style.display = 'none';
    msg.style.display = '';
  }

  function renderCharts(series) {
    const ctx1 = document.getElementById('chart_eventos');
    const ctx2 = document.getElementById('chart_encuestas');
    const ed = series?.eventos_por_dia || { labels: [], data: [] };
    const en = series?.encuestas || { labels: [], data: [] };

    // Utilidad: color de alto contraste según fondo
    const contrastColor = (hex) => {
      if (!hex || typeof hex !== 'string') return '#2b313f';
      const h = hex.replace('#','');
      const v = h.length === 3 ? h.split('').map(c=>c+c).join('') : h;
      const num = parseInt(v,16);
      const r = (num>>16)&255, g=(num>>8)&255, b=num&255;
      const lum = 0.299*r + 0.587*g + 0.114*b; // percepción
      return lum < 140 ? '#d2dee3' : '#2b313f';
    };

    const barBg = '#59b9c7';
    chartEventos = new Chart(ctx1, {
      type: 'bar',
      data: {
        labels: ed.labels,
        datasets: [{ label: 'Eventos por día', data: ed.data, backgroundColor: barBg, borderColor: '#2b313f', borderWidth: 1 }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: { display: true, text: 'Eventos por día', color: '#2b313f', font: { weight: 'bold' } },
          legend: { display: false },
          datalabels: {
            anchor: 'center',
            align: 'center',
            clamp: true,
            color: (ctx) => contrastColor(ctx.dataset.backgroundColor || barBg),
            formatter: (v) => (Number.isFinite(v) && v > 0 ? Math.round(v) : ''),
            display: (ctx) => (ctx.dataset.data[ctx.dataIndex] > 0)
          },
        },
        scales: {
          y: { beginAtZero: true, ticks: { stepSize: 1, callback: (v) => Number.isInteger(v) ? v : '' } }
        },
        onClick: (evt, elements, chart) => {
          if (!elements || !elements.length) return;
          const idx = elements[0].index;
          const label = chart.data.labels[idx];
          selectedDay = (selectedDay === label ? null : label);
          applyTableFilters();
        }
      }
    });

    chartEncuestas = new Chart(ctx2, {
      type: 'doughnut',
      data: { labels: en.labels, datasets: [{ data: en.data, backgroundColor: ['#2b313f', '#aebed2'], borderColor: '#232833' }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: { display: true, text: 'Encuestas (Completadas vs Pendientes)', color: '#2b313f', font: { weight: 'bold' } },
          legend: { position: 'bottom' },
          datalabels: {
            anchor: 'center',
            align: 'center',
            clamp: true,
            font: { size: 11, weight: '600' },
            color: (ctx) => {
              const bg = (ctx.dataset.backgroundColor || ['#2b313f','#aebed2'])[ctx.dataIndex] || '#2b313f';
              return contrastColor(bg);
            },
            formatter: (v, ctx) => {
              const data = ctx.chart.data.datasets[0].data || [];
              const total = data.reduce((a, b) => a + (typeof b === 'number' ? b : parseFloat(b) || 0), 0) || 1;
              const pct = ((v / total) * 100);
              if (pct < 1 && v === 0) return '';
              const pctStr = pct < 10 ? pct.toFixed(1) : pct.toFixed(0);
              return `${v} (${pctStr}%)`;
            },
            display: (ctx) => (ctx.dataset.data[ctx.dataIndex] > 0)
          },
        },
        onClick: (evt, elements, chart) => {
          if (!elements || !elements.length) return;
          const idx = elements[0].index;
          const label = chart.data.labels[idx]; // 'Completadas' | 'Pendientes'
          selectedStatus = (selectedStatus === label ? null : label);
          applyTableFilters();
        }
      }
    });
  }

  function renderEventos(eventos) {
    tbody.innerHTML = '';
    for (const ev of (eventos || [])) {
      const tr = document.createElement('tr');
      const qas = (ev.qa || []).map(q => `${q.pregunta || ''}: ${q.respuesta || ''}`).join('<br/>');
      tr.innerHTML = `
        <td>${ev.nombre}</td>
        <td>${ev.telefono || ''}</td>
        <td>${ev.ticket}</td>
        <td>${(ev.fecha_registro || '').slice(0,10)}</td>
        <td style="text-align:left">${qas}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  function renderKpi(kpi) {
    if (!kpiWrap) return;
    try {
      const fmt = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', maximumFractionDigits: 2 });
      const avg = parseFloat(kpi?.avg_ticket || '0') || 0;
      const total = parseFloat(kpi?.total_ticket || '0') || 0;
      kpiAvg.textContent = fmt.format(avg);
      kpiTotal.textContent = fmt.format(total);
      kpiNum.textContent = String(kpi?.num_eventos ?? 0);
    } catch (_) {
      kpiAvg.textContent = kpi?.avg_ticket || '0';
      kpiTotal.textContent = kpi?.total_ticket || '0';
      kpiNum.textContent = String(kpi?.num_eventos ?? 0);
    }
  }

  function updateKpiFromEvents(evs) {
    if (!kpiWrap) return;
    const n = evs.length;
    let total = 0;
    for (const e of evs) {
      const t = parseFloat(e.ticket);
      if (!isNaN(t)) total += t;
    }
    const avg = n ? total / n : 0;
    try {
      const fmt = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', maximumFractionDigits: 2 });
      kpiAvg.textContent = fmt.format(avg);
      kpiTotal.textContent = fmt.format(total);
    } catch (_) {
      kpiAvg.textContent = String(avg.toFixed(2));
      kpiTotal.textContent = String(total.toFixed(2));
    }
    kpiNum.textContent = String(n);
  }

  function applyTableFilters() {
    let evs = lastEventos.slice();
    if (selectedDay) {
      evs = evs.filter(e => (e.fecha_registro || '').slice(0,10) === selectedDay);
    }
    if (selectedStatus) {
      const wantCompleted = (selectedStatus === 'Completadas');
      evs = evs.filter(e => !!e.completada === wantCompleted);
    }
    renderEventos(evs);
    updateKpiFromEvents(evs);
  }

  async function fetchData() {
    const clienteId = selCliente.value;
    if (!clienteId) { resetUI(); return; }

    const params = new URLSearchParams();
    params.set('cliente_id', clienteId);
    if (desde.value) params.set('fecha_desde', desde.value);
    if (hasta.value) params.set('fecha_hasta', hasta.value);

    const url = `${window.REPORTES_DATA_URL}?${params.toString()}`;
    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if (!res.ok) { resetUI(); return; }
    const data = await res.json();

    // Mostrar secciones
    msg.style.display = 'none';
    chartsWrap.style.display = '';
    eventosWrap.style.display = '';
    if (kpiWrap) kpiWrap.style.display = '';

    // Render
    renderCharts(data.series);
    lastEventos = data.eventos || [];
    selectedDay = null;
    selectedStatus = null;
    renderEventos(lastEventos);
    renderKpi(data.kpi || null);
  }

  form.addEventListener('submit', (e) => { e.preventDefault(); fetchData(); });
  selCliente.addEventListener('change', fetchData);
  btnLimpiar.addEventListener('click', (e) => { e.preventDefault(); selCliente.value=''; desde.value=''; hasta.value=''; resetUI(); });

  resetUI();
})();

